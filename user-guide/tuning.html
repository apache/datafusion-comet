<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tuning Guide &#8212; Apache DataFusion Comet  documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css?v=1140d252" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=c6d785ac" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="true" defer="true" src="https://buttons.github.io/buttons.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing to Apache DataFusion Comet" href="../contributor-guide/contributing.html" />
    <link rel="prev" title="Compatibility Guide" href="compatibility.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    


    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  User Guide
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="overview.html">
   Comet Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="installation.html">
   Installing Comet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="source.html">
   Building From Source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kubernetes.html">
   Kubernetes Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datasources.html">
   Supported Data Sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datatypes.html">
   Supported Data Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="operators.html">
   Supported Operators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="expressions.html">
   Supported Expressions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="configs.html">
   Configuration Settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="compatibility.html">
   Compatibility Guide
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Tuning Guide
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributor Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/contributing.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/plugin_overview.html">
   Comet Plugin Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/development.html">
   Development Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/debugging.html">
   Debugging Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/benchmarking.html">
   Benchmarking Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/adding_a_new_expression.html">
   Adding a New Expression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/profiling_native_code.html">
   Profiling Native Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/spark-sql-tests.html">
   Spark SQL Tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion-comet">
   Github and Issue Tracker
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ASF Links
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://apache.org">
   Apache Software Foundation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/licenses/">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/sponsorship.html">
   Donate
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/thanks.html">
   Thanks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/security/">
   Security
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/policies/conduct.html">
   Code of conduct
  </a>
 </li>
</ul>

    
  </div>

  <a class="navbar-brand" href="../index.html">
    <img src="../_static/images/DataFusionComet-Logo-Light.png" class="logo" alt="logo">
  </a>
</nav>

              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#memory-tuning">
   Memory Tuning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unified-memory-management">
     Unified Memory Management
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#native-memory-management">
     Native Memory Management
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#determining-how-much-memory-to-allocate">
     Determining How Much Memory to Allocate
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#configuring-spark-executor-memoryoverhead">
   Configuring spark.executor.memoryOverhead
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shuffle">
   Shuffle
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shuffle-mode">
     Shuffle Mode
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#auto-mode">
       Auto Mode
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#columnar-jvm-shuffle">
       Columnar (JVM) Shuffle
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#native-shuffle">
       Native Shuffle
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#metrics">
   Metrics
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/apache/datafusion-comet/edit/main/docs/source/user-guide/tuning.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <!---
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<section id="tuning-guide">
<h1>Tuning Guide<a class="headerlink" href="#tuning-guide" title="Link to this heading">¶</a></h1>
<p>Comet provides some tuning options to help you get the best performance from your queries.</p>
<section id="memory-tuning">
<h2>Memory Tuning<a class="headerlink" href="#memory-tuning" title="Link to this heading">¶</a></h2>
<p>Comet provides two options for memory management:</p>
<ul class="simple">
<li><p><strong>Unified Memory Management</strong> shares an off-heap memory pool between Spark and Comet. This is the recommended option.</p></li>
<li><p><strong>Native Memory Management</strong> leverages DataFusion’s memory management for the native plans and allocates memory independently of Spark.</p></li>
</ul>
<section id="unified-memory-management">
<h3>Unified Memory Management<a class="headerlink" href="#unified-memory-management" title="Link to this heading">¶</a></h3>
<p>This option is automatically enabled when <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.enabled=true</span></code>.</p>
<p>Each executor will have a single memory pool which will be shared by all native plans being executed within that
process, and by Spark itself. The size of the pool is specified by <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.size</span></code>.</p>
</section>
<section id="native-memory-management">
<h3>Native Memory Management<a class="headerlink" href="#native-memory-management" title="Link to this heading">¶</a></h3>
<p>This option is automatically enabled when <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.enabled=false</span></code>.</p>
<p>Each native plan has a dedicated memory pool.</p>
<p>By default, the size of each pool is <code class="docutils literal notranslate"><span class="pre">spark.comet.memory.overhead.factor</span> <span class="pre">*</span> <span class="pre">spark.executor.memory</span></code>. The default value
for <code class="docutils literal notranslate"><span class="pre">spark.comet.memory.overhead.factor</span></code> is <code class="docutils literal notranslate"><span class="pre">0.2</span></code>.</p>
<p>It is important to take executor concurrency into account. The maximum number of concurrent plans in an executor can
be calculated with <code class="docutils literal notranslate"><span class="pre">spark.executor.cores</span> <span class="pre">/</span> <span class="pre">spark.task.cpus</span></code>.</p>
<p>For example, if the executor can execute 4 plans concurrently, then the total amount of memory allocated will be
<code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">spark.comet.memory.overhead.factor</span> <span class="pre">*</span> <span class="pre">spark.executor.memory</span></code>.</p>
<p>It is also possible to set <code class="docutils literal notranslate"><span class="pre">spark.comet.memoryOverhead</span></code> to the desired size for each pool, rather than calculating
it based on <code class="docutils literal notranslate"><span class="pre">spark.comet.memory.overhead.factor</span></code>.</p>
<p>If both <code class="docutils literal notranslate"><span class="pre">spark.comet.memoryOverhead</span></code> and <code class="docutils literal notranslate"><span class="pre">spark.comet.memory.overhead.factor</span></code> are set, the former will be used.</p>
<p>Comet will allocate at least <code class="docutils literal notranslate"><span class="pre">spark.comet.memory.overhead.min</span></code> memory per pool.</p>
</section>
<section id="determining-how-much-memory-to-allocate">
<h3>Determining How Much Memory to Allocate<a class="headerlink" href="#determining-how-much-memory-to-allocate" title="Link to this heading">¶</a></h3>
<p>Generally, increasing memory overhead will improve query performance, especially for queries containing joins and
aggregates.</p>
<p>Once a memory pool is exhausted, the native plan will start spilling to disk, which will slow down the query.</p>
<p>Insufficient memory allocation can also lead to out-of-memory (OOM) errors.</p>
</section>
</section>
<section id="configuring-spark-executor-memoryoverhead">
<h2>Configuring spark.executor.memoryOverhead<a class="headerlink" href="#configuring-spark-executor-memoryoverhead" title="Link to this heading">¶</a></h2>
<p>In some environments, such as Kubernetes and YARN, it is important to correctly set <code class="docutils literal notranslate"><span class="pre">spark.executor.memoryOverhead</span></code> so
that it is possible to allocate off-heap memory.</p>
<p>Comet will automatically set <code class="docutils literal notranslate"><span class="pre">spark.executor.memoryOverhead</span></code> based on the <code class="docutils literal notranslate"><span class="pre">spark.comet.memory*</span></code> settings so that
resource managers respect Apache Spark memory configuration before starting the containers.</p>
<p>Note that there is currently a known issue where this will be inaccurate when using Native Memory Management because it
does not take executor concurrency into account. The tracking issue for this is
https://github.com/apache/datafusion-comet/issues/949.</p>
</section>
<section id="shuffle">
<h2>Shuffle<a class="headerlink" href="#shuffle" title="Link to this heading">¶</a></h2>
<p>Comet provides accelerated shuffle implementations that can be used to improve the performance of your queries.</p>
<p>To enable Comet shuffle, set the following configuration in your Spark configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">shuffle</span><span class="o">.</span><span class="n">manager</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">comet</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">shuffle</span><span class="o">.</span><span class="n">CometShuffleManager</span>
<span class="n">spark</span><span class="o">.</span><span class="n">comet</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">shuffle</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spark.shuffle.manager</span></code> is a Spark static configuration which cannot be changed at runtime.
It must be set before the Spark context is created. You can enable or disable Comet shuffle
at runtime by setting <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code>.
Once it is disabled, Comet will fall back to the default Spark shuffle manager.</p>
<section id="shuffle-mode">
<h3>Shuffle Mode<a class="headerlink" href="#shuffle-mode" title="Link to this heading">¶</a></h3>
<p>Comet provides three shuffle modes: Columnar Shuffle, Native Shuffle and Auto Mode.</p>
<section id="auto-mode">
<h4>Auto Mode<a class="headerlink" href="#auto-mode" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.mode</span></code> to <code class="docutils literal notranslate"><span class="pre">auto</span></code> will let Comet choose the best shuffle mode based on the query plan. This
is the default.</p>
</section>
<section id="columnar-jvm-shuffle">
<h4>Columnar (JVM) Shuffle<a class="headerlink" href="#columnar-jvm-shuffle" title="Link to this heading">¶</a></h4>
<p>Comet Columnar shuffle is JVM-based and supports <code class="docutils literal notranslate"><span class="pre">HashPartitioning</span></code>, <code class="docutils literal notranslate"><span class="pre">RoundRobinPartitioning</span></code>, <code class="docutils literal notranslate"><span class="pre">RangePartitioning</span></code>, and
<code class="docutils literal notranslate"><span class="pre">SinglePartitioning</span></code>. This mode has the highest query coverage.</p>
<p>Columnar shuffle can be enabled by setting <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.mode</span></code> to <code class="docutils literal notranslate"><span class="pre">jvm</span></code>. If this mode is explicitly set,
then any shuffle operations that cannot be supported in this mode will fall back to Spark.</p>
</section>
<section id="native-shuffle">
<h4>Native Shuffle<a class="headerlink" href="#native-shuffle" title="Link to this heading">¶</a></h4>
<p>Comet also provides a fully native shuffle implementation, which generally provides the best performance. However,
native shuffle currently only supports <code class="docutils literal notranslate"><span class="pre">HashPartitioning</span></code> and <code class="docutils literal notranslate"><span class="pre">SinglePartitioning</span></code>.</p>
<p>To enable native shuffle, set <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.mode</span></code> to <code class="docutils literal notranslate"><span class="pre">native</span></code>. If this mode is explicitly set,
then any shuffle operations that cannot be supported in this mode will fall back to Spark.</p>
</section>
</section>
</section>
<section id="metrics">
<h2>Metrics<a class="headerlink" href="#metrics" title="Link to this heading">¶</a></h2>
<p>Comet metrics are not directly comparable to Spark metrics in some cases.</p>
<p><code class="docutils literal notranslate"><span class="pre">CometScanExec</span></code> uses nanoseconds for total scan time. Spark also measures scan time in nanoseconds but converts to
milliseconds <em>per batch</em> which can result in a large loss of precision. In one case we saw total scan time
of 41 seconds reported as 23 seconds for example.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="compatibility.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compatibility Guide</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../contributor-guide/contributing.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Contributing to Apache DataFusion Comet</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  
<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2023-2024, Apache Software Foundation.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.1.0.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p>Apache DataFusion, Apache DataFusion Comet, Apache, the Apache feather logo, and the Apache DataFusion project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>