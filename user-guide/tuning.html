<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Comet Tuning Guide &#8212; Apache DataFusion Comet  documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css?v=1140d252" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=c6d785ac" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="true" defer="true" src="https://buttons.github.io/buttons.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Comet Metrics" href="metrics.html" />
    <link rel="prev" title="Compatibility Guide" href="compatibility.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    


    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  User Guide
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="overview.html">
   Comet Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="installation.html">
   Installing Comet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="source.html">
   Building From Source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kubernetes.html">
   Kubernetes Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datasources.html">
   Supported Spark Data Sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datatypes.html">
   Supported Data Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="operators.html">
   Supported Operators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="expressions.html">
   Supported Expressions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="configs.html">
   Configuration Settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="compatibility.html">
   Compatibility Guide
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Tuning Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="metrics.html">
   Metrics Guide
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributor Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/contributing.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/plugin_overview.html">
   Comet Plugin Architecture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/development.html">
   Development Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/debugging.html">
   Debugging Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/benchmarking.html">
   Benchmarking Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/adding_a_new_expression.html">
   Adding a New Expression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/profiling_native_code.html">
   Profiling Native Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/spark-sql-tests.html">
   Spark SQL Tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion-comet">
   Github and Issue Tracker
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ASF Links
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://apache.org">
   Apache Software Foundation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/licenses/">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/sponsorship.html">
   Donate
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/thanks.html">
   Thanks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/security/">
   Security
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/policies/conduct.html">
   Code of conduct
  </a>
 </li>
</ul>

    
  </div>

  <a class="navbar-brand" href="../index.html">
    <img src="../_static/images/DataFusionComet-Logo-Light.png" class="logo" alt="logo">
  </a>
</nav>

              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#configuring-tokio-runtime">
   Configuring Tokio Runtime
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#memory-tuning">
   Memory Tuning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuring-comet-memory-in-off-heap-mode">
     Configuring Comet Memory in Off-Heap Mode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuring-comet-memory-in-on-heap-mode">
     Configuring Comet Memory in On-Heap Mode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#determining-how-much-memory-to-allocate">
     Determining How Much Memory to Allocate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sortexec">
     SortExec
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-memory-tuning">
   Advanced Memory Tuning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuring-spark-executor-memoryoverhead-in-on-heap-mode">
     Configuring spark.executor.memoryOverhead in On-Heap Mode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuring-off-heap-memory-pools">
     Configuring Off-Heap Memory Pools
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuring-on-heap-memory-pools">
     Configuring On-Heap Memory Pools
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimizing-joins">
   Optimizing Joins
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shuffle">
   Shuffle
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shuffle-implementations">
     Shuffle Implementations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#native-shuffle">
       Native Shuffle
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#columnar-jvm-shuffle">
       Columnar (JVM) Shuffle
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shuffle-compression">
     Shuffle Compression
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explain-plan">
   Explain Plan
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extended-explain">
     Extended Explain
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/apache/datafusion-comet/edit/main/docs/source/user-guide/tuning.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <!---
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<section id="comet-tuning-guide">
<h1>Comet Tuning Guide<a class="headerlink" href="#comet-tuning-guide" title="Link to this heading">¶</a></h1>
<p>Comet provides some tuning options to help you get the best performance from your queries.</p>
<section id="configuring-tokio-runtime">
<h2>Configuring Tokio Runtime<a class="headerlink" href="#configuring-tokio-runtime" title="Link to this heading">¶</a></h2>
<p>Comet uses a global tokio runtime per executor process using tokio’s defaults of one worker thread per core and a
maximum of 512 blocking threads. These values can be overridden using the environment variables <code class="docutils literal notranslate"><span class="pre">COMET_WORKER_THREADS</span></code>
and <code class="docutils literal notranslate"><span class="pre">COMET_MAX_BLOCKING_THREADS</span></code>.</p>
<p>DataFusion currently has a known issue when merging spill files in sort operators where the process can deadlock if
there are more spill files than <code class="docutils literal notranslate"><span class="pre">COMET_MAX_BLOCKING_THREADS</span></code> (<a class="reference external" href="https://github.com/apache/datafusion/issues/15323">tracking issue</a>).</p>
</section>
<section id="memory-tuning">
<h2>Memory Tuning<a class="headerlink" href="#memory-tuning" title="Link to this heading">¶</a></h2>
<p>It is necessary to specify how much memory Comet can use in addition to memory already allocated to Spark. In some
cases, it may be possible to reduce the amount of memory allocated to Spark so that overall memory allocation is
the same or lower than the original configuration. In other cases, enabling Comet may require allocating more memory
than before. See the <a class="reference internal" href="#determining-how-much-memory-to-allocate">Determining How Much Memory to Allocate</a> section for more details.</p>
<p>Comet supports Spark’s on-heap (the default) and off-heap mode for allocating memory. However, we strongly recommend
using off-heap mode. Comet has some limitations when running in on-heap mode, such as requiring more memory overall,
and requiring shuffle memory to be separately configured.</p>
<section id="configuring-comet-memory-in-off-heap-mode">
<h3>Configuring Comet Memory in Off-Heap Mode<a class="headerlink" href="#configuring-comet-memory-in-off-heap-mode" title="Link to this heading">¶</a></h3>
<p>The recommended way to allocate memory for Comet is to set <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.enabled=true</span></code>. This allows
Comet to share an off-heap memory pool with Spark, reducing the overall memory overhead. The size of the pool is
specified by <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.size</span></code>. For more details about Spark off-heap memory mode, please refer to
Spark documentation: https://spark.apache.org/docs/latest/configuration.html.</p>
</section>
<section id="configuring-comet-memory-in-on-heap-mode">
<h3>Configuring Comet Memory in On-Heap Mode<a class="headerlink" href="#configuring-comet-memory-in-on-heap-mode" title="Link to this heading">¶</a></h3>
<p>When running in on-heap mode, Comet memory can be allocated by setting <code class="docutils literal notranslate"><span class="pre">spark.comet.memoryOverhead</span></code>. If this setting
is not provided, it will be calculated by multiplying the current Spark executor memory by
<code class="docutils literal notranslate"><span class="pre">spark.comet.memory.overhead.factor</span></code> (default value is <code class="docutils literal notranslate"><span class="pre">0.2</span></code>) which may or may not result in enough memory for
Comet to operate. It is not recommended to rely on this behavior. It is better to specify <code class="docutils literal notranslate"><span class="pre">spark.comet.memoryOverhead</span></code>
explicitly.</p>
<p>Comet supports native shuffle and columnar shuffle (these terms are explained in the <a class="reference internal" href="#shuffle">shuffle</a> section below).
In on-heap mode, columnar shuffle memory must be separately allocated using <code class="docutils literal notranslate"><span class="pre">spark.comet.columnar.shuffle.memorySize</span></code>.
If this setting is not provided, it will be calculated by multiplying <code class="docutils literal notranslate"><span class="pre">spark.comet.memoryOverhead</span></code> by
<code class="docutils literal notranslate"><span class="pre">spark.comet.columnar.shuffle.memory.factor</span></code> (default value is <code class="docutils literal notranslate"><span class="pre">1.0</span></code>). If a shuffle exceeds this amount of memory
then the query will fail.</p>
</section>
<section id="determining-how-much-memory-to-allocate">
<h3>Determining How Much Memory to Allocate<a class="headerlink" href="#determining-how-much-memory-to-allocate" title="Link to this heading">¶</a></h3>
<p>Generally, increasing the amount of memory allocated to Comet will improve query performance by reducing the
amount of time spent spilling to disk, especially for aggregate, join, and shuffle operations. Allocating insufficient
memory can result in out-of-memory errors. This is no different from allocating memory in Spark and the amount of
memory will vary for different workloads, so some experimentation will be required.</p>
<p>Here is a real-world example, based on running benchmarks derived from TPC-H, running on a single executor against
local Parquet files using the 100 GB data set.</p>
<p>Baseline Spark Performance</p>
<ul class="simple">
<li><p>Spark completes the benchmark in 632 seconds with 8 cores and 8 GB RAM</p></li>
<li><p>With less than 8 GB RAM, performance degrades due to spilling</p></li>
<li><p>Spark can complete the benchmark with as little as 3 GB of RAM, but with worse performance (744 seconds)</p></li>
</ul>
<p>Comet Performance</p>
<ul class="simple">
<li><p>Comet requires at least 5 GB of RAM in off-heap mode and 6 GB RAM in on-heap mode, but performance at this level
is around 340 seconds, which is significantly faster than Spark with any amount of RAM</p></li>
<li><p>Comet running in off-heap with 8 cores completes the benchmark in 295 seconds, more than 2x faster than Spark</p></li>
<li><p>It is worth noting that running Comet with only 4 cores and 4 GB RAM completes the benchmark in 520 seconds,
providing better performance than Spark for half the resource</p></li>
</ul>
<p>It may be possible to reduce Comet’s memory overhead by reducing batch sizes or increasing number of partitions.</p>
</section>
<section id="sortexec">
<h3>SortExec<a class="headerlink" href="#sortexec" title="Link to this heading">¶</a></h3>
<p>Comet’s SortExec implementation spills to disk when under memory pressure, but there are some known issues in the
underlying DataFusion SortExec implementation that could cause out-of-memory errors during spilling. See
https://github.com/apache/datafusion/issues/14692 for more information.</p>
<p>Workarounds for this problem include:</p>
<ul class="simple">
<li><p>Allocating more off-heap memory</p></li>
<li><p>Disabling native sort by setting <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.sort.enabled=false</span></code></p></li>
</ul>
</section>
</section>
<section id="advanced-memory-tuning">
<h2>Advanced Memory Tuning<a class="headerlink" href="#advanced-memory-tuning" title="Link to this heading">¶</a></h2>
<section id="configuring-spark-executor-memoryoverhead-in-on-heap-mode">
<h3>Configuring spark.executor.memoryOverhead in On-Heap Mode<a class="headerlink" href="#configuring-spark-executor-memoryoverhead-in-on-heap-mode" title="Link to this heading">¶</a></h3>
<p>In some environments, such as Kubernetes and YARN, it is important to correctly set <code class="docutils literal notranslate"><span class="pre">spark.executor.memoryOverhead</span></code> so
that it is possible to allocate off-heap memory when running in on-heap mode.</p>
<p>Comet will automatically set <code class="docutils literal notranslate"><span class="pre">spark.executor.memoryOverhead</span></code> based on the <code class="docutils literal notranslate"><span class="pre">spark.comet.memory*</span></code> settings so that
resource managers respect Apache Spark memory configuration before starting the containers.</p>
</section>
<section id="configuring-off-heap-memory-pools">
<h3>Configuring Off-Heap Memory Pools<a class="headerlink" href="#configuring-off-heap-memory-pools" title="Link to this heading">¶</a></h3>
<p>Comet implements multiple memory pool implementations. The type of pool can be specified with <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.memoryPool</span></code>.</p>
<p>The valid pool types for off-heap mode are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">unified</span></code> (default when <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.enabled=true</span></code> is set)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fair_unified</span></code></p></li>
</ul>
<p>Both of these pools share off-heap memory between Spark and Comet. This approach is referred to as
unified memory management. The size of the pool is specified by <code class="docutils literal notranslate"><span class="pre">spark.memory.offHeap.size</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">unified</span></code> pool type implements a greedy first-come first-serve limit. This pool works well for queries that do not
need to spill or have a single spillable operator.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fair_unified</span></code> pool type prevents operators from using more than an even fraction of the available memory
(i.e. <code class="docutils literal notranslate"><span class="pre">pool_size</span> <span class="pre">/</span> <span class="pre">num_reservations</span></code>). This pool works best when you know beforehand
the query has multiple operators that will likely all need to spill. Sometimes it will cause spills even
when there is sufficient memory in order to leave enough memory for other operators.</p>
</section>
<section id="configuring-on-heap-memory-pools">
<h3>Configuring On-Heap Memory Pools<a class="headerlink" href="#configuring-on-heap-memory-pools" title="Link to this heading">¶</a></h3>
<p>When running in on-heap mode, Comet will use its own dedicated memory pools that are not shared with Spark.</p>
<p>The type of pool can be specified with <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.memoryPool</span></code>. The default setting is <code class="docutils literal notranslate"><span class="pre">greedy_task_shared</span></code>.</p>
<p>The valid pool types for on-heap mode are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">greedy</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">greedy_global</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">greedy_task_shared</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fair_spill</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fair_spill_global</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fair_spill_task_shared</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unbounded</span></code></p></li>
</ul>
<p>Pool types ending with <code class="docutils literal notranslate"><span class="pre">_global</span></code> use a single global memory pool between all tasks on same executor.</p>
<p>Pool types ending with <code class="docutils literal notranslate"><span class="pre">_task_shared</span></code> share a single memory pool across all attempts for a single task.</p>
<p>Other pool types create a dedicated pool per native query plan using a fraction of the available pool size based on number of cores
and cores per task.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">greedy*</span></code> pool types use DataFusion’s <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/execution/memory_pool/struct.GreedyMemoryPool.html">GreedyMemoryPool</a>, which implements a greedy first-come first-serve limit. This
pool works well for queries that do not need to spill or have a single spillable operator.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fair_spill*</span></code> pool types use DataFusion’s <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/execution/memory_pool/struct.FairSpillPool.html">FairSpillPool</a>, which prevents spillable reservations from using more
than an even fraction of the available memory sans any unspillable reservations
(i.e. <code class="docutils literal notranslate"><span class="pre">(pool_size</span> <span class="pre">-</span> <span class="pre">unspillable_memory)</span> <span class="pre">/</span> <span class="pre">num_spillable_reservations</span></code>). This pool works best when you know beforehand
the query has multiple spillable operators that will likely all need to spill. Sometimes it will cause spills even
when there was sufficient memory (reserved for other operators) to avoid doing so. Unspillable memory is allocated in
a first-come, first-serve fashion</p>
<p>The <code class="docutils literal notranslate"><span class="pre">unbounded</span></code> pool type uses DataFusion’s <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/execution/memory_pool/struct.UnboundedMemoryPool.html">UnboundedMemoryPool</a>, which enforces no limit. This option is useful for
development/testing purposes, where there is no room to allow spilling and rather choose to fail the job.
Spilling significantly slows down the job and this option is one way to measure the best performance scenario without
adjusting how much memory to allocate.</p>
</section>
</section>
<section id="optimizing-joins">
<h2>Optimizing Joins<a class="headerlink" href="#optimizing-joins" title="Link to this heading">¶</a></h2>
<p>Spark often chooses <code class="docutils literal notranslate"><span class="pre">SortMergeJoin</span></code> over <code class="docutils literal notranslate"><span class="pre">ShuffledHashJoin</span></code> for stability reasons. If the build-side of a
<code class="docutils literal notranslate"><span class="pre">ShuffledHashJoin</span></code> is very large then it could lead to OOM in Spark.</p>
<p>Vectorized query engines tend to perform better with <code class="docutils literal notranslate"><span class="pre">ShuffledHashJoin</span></code>, so for best performance it is often preferable
to configure Comet to convert <code class="docutils literal notranslate"><span class="pre">SortMergeJoin</span></code> to <code class="docutils literal notranslate"><span class="pre">ShuffledHashJoin</span></code>. Comet does not yet provide spill-to-disk for
<code class="docutils literal notranslate"><span class="pre">ShuffledHashJoin</span></code> so this could result in OOM. Also, <code class="docutils literal notranslate"><span class="pre">SortMergeJoin</span></code> may still be faster in some cases. It is best
to test with both for your specific workloads.</p>
<p>To configure Comet to convert <code class="docutils literal notranslate"><span class="pre">SortMergeJoin</span></code> to <code class="docutils literal notranslate"><span class="pre">ShuffledHashJoin</span></code>, set <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.replaceSortMergeJoin=true</span></code>.</p>
</section>
<section id="shuffle">
<h2>Shuffle<a class="headerlink" href="#shuffle" title="Link to this heading">¶</a></h2>
<p>Comet provides accelerated shuffle implementations that can be used to improve the performance of your queries.</p>
<p>To enable Comet shuffle, set the following configuration in your Spark configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">shuffle</span><span class="o">.</span><span class="n">manager</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">comet</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">shuffle</span><span class="o">.</span><span class="n">CometShuffleManager</span>
<span class="n">spark</span><span class="o">.</span><span class="n">comet</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">shuffle</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spark.shuffle.manager</span></code> is a Spark static configuration which cannot be changed at runtime.
It must be set before the Spark context is created. You can enable or disable Comet shuffle
at runtime by setting <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code>.
Once it is disabled, Comet will fall back to the default Spark shuffle manager.</p>
<section id="shuffle-implementations">
<h3>Shuffle Implementations<a class="headerlink" href="#shuffle-implementations" title="Link to this heading">¶</a></h3>
<p>Comet provides two shuffle implementations: Native Shuffle and Columnar Shuffle. Comet will first try to use Native
Shuffle and if that is not possible it will try to use Columnar Shuffle. If neither can be applied, it will fall
back to Spark for shuffle operations.</p>
<section id="native-shuffle">
<h4>Native Shuffle<a class="headerlink" href="#native-shuffle" title="Link to this heading">¶</a></h4>
<p>Comet provides a fully native shuffle implementation, which generally provides the best performance. However,
native shuffle currently only supports <code class="docutils literal notranslate"><span class="pre">HashPartitioning</span></code> and <code class="docutils literal notranslate"><span class="pre">SinglePartitioning</span></code> and has some restrictions on
supported data types.</p>
</section>
<section id="columnar-jvm-shuffle">
<h4>Columnar (JVM) Shuffle<a class="headerlink" href="#columnar-jvm-shuffle" title="Link to this heading">¶</a></h4>
<p>Comet Columnar shuffle is JVM-based and supports <code class="docutils literal notranslate"><span class="pre">HashPartitioning</span></code>, <code class="docutils literal notranslate"><span class="pre">RoundRobinPartitioning</span></code>, <code class="docutils literal notranslate"><span class="pre">RangePartitioning</span></code>, and
<code class="docutils literal notranslate"><span class="pre">SinglePartitioning</span></code>. This shuffle implementation supports more data types than native shuffle.</p>
</section>
</section>
<section id="shuffle-compression">
<h3>Shuffle Compression<a class="headerlink" href="#shuffle-compression" title="Link to this heading">¶</a></h3>
<p>By default, Spark compresses shuffle files using LZ4 compression. Comet overrides this behavior with ZSTD compression.
Compression can be disabled by setting <code class="docutils literal notranslate"><span class="pre">spark.shuffle.compress=false</span></code>, which may result in faster shuffle times in
certain environments, such as single-node setups with fast NVMe drives, at the expense of increased disk space usage.</p>
</section>
</section>
<section id="explain-plan">
<h2>Explain Plan<a class="headerlink" href="#explain-plan" title="Link to this heading">¶</a></h2>
<section id="extended-explain">
<h3>Extended Explain<a class="headerlink" href="#extended-explain" title="Link to this heading">¶</a></h3>
<p>With Spark 4.0.0 and newer, Comet can provide extended explain plan information in the Spark UI. Currently this lists
reasons why Comet may not have been enabled for specific operations.
To enable this, in the Spark configuration, set the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>-c<span class="w"> </span>spark.sql.extendedExplainProviders<span class="o">=</span>org.apache.comet.ExtendedExplainInfo
</pre></div>
</div>
<p>This will add a section to the detailed plan displayed in the Spark SQL UI page.</p>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="compatibility.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compatibility Guide</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="metrics.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Comet Metrics</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  
<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2023-2024, Apache Software Foundation.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.1.3.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p>Apache DataFusion, Apache DataFusion Comet, Apache, the Apache feather logo, and the Apache DataFusion project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>