<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->


<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>JVM Shuffle &#8212; Apache DataFusion Comet  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=cd442bcd" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'contributor-guide/jvm_shuffle';</script>
    <script async="true" defer="true" src="https://buttons.github.io/buttons.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Native Shuffle" href="native_shuffle.html" />
    <link rel="prev" title="Arrow FFI Usage in Comet" href="ffi.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/DataFusionComet-Logo-Light.png" class="logo__image only-light" alt="Apache DataFusion Comet  documentation - Home"/>
    <img src="../_static/DataFusionComet-Logo-Dark.png" class="logo__image only-dark pst-js-only" alt="Apache DataFusion Comet  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    Comet Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user-guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../asf/index.html">
    ASF Links
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/apache/datafusion-comet" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    Comet Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user-guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../asf/index.html">
    ASF Links
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/apache/datafusion-comet" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p aria-level="2" class="caption" role="heading"><span class="caption-text">Index</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">Comet Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Contributor Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin_overview.html">Comet Plugin Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin_overview.html#plugin-components">Plugin Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="ffi.html">Arrow FFI</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">JVM Shuffle</a></li>
<li class="toctree-l2"><a class="reference internal" href="native_shuffle.html">Native Shuffle</a></li>
<li class="toctree-l2"><a class="reference internal" href="parquet_scans.html">Parquet Scans</a></li>
<li class="toctree-l2"><a class="reference internal" href="development.html">Development Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Debugging Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmarking.html">Benchmarking Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_new_operator.html">Adding a New Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_new_expression.html">Adding a New Expression</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="profiling_native_code.html">Profiling Native Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="spark-sql-tests.html">Spark SQL Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l2"><a class="reference external" href="https://github.com/apache/datafusion-comet">Github and Issue Tracker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../asf/index.html">ASF Links</a></li>
</ul>

  </div>
</nav>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Comet Contributor Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">JVM Shuffle</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<section id="jvm-shuffle">
<h1>JVM Shuffle<a class="headerlink" href="#jvm-shuffle" title="Link to this heading">#</a></h1>
<p>This document describes Comet’s JVM-based columnar shuffle implementation (<code class="docutils literal notranslate"><span class="pre">CometColumnarShuffle</span></code>), which
writes shuffle data in Arrow IPC format using JVM code with native encoding. For the fully native
alternative, see <a class="reference internal" href="native_shuffle.html"><span class="std std-doc">Native Shuffle</span></a>.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Comet provides two shuffle implementations:</p>
<ul class="simple">
<li><p><strong>CometNativeShuffle</strong> (<code class="docutils literal notranslate"><span class="pre">CometExchange</span></code>): Fully native shuffle using Rust. Takes columnar input directly
from Comet native operators and performs partitioning in native code.</p></li>
<li><p><strong>CometColumnarShuffle</strong> (<code class="docutils literal notranslate"><span class="pre">CometColumnarExchange</span></code>): JVM-based shuffle that operates on rows internally,
buffers <code class="docutils literal notranslate"><span class="pre">UnsafeRow</span></code>s in memory pages, and uses native code (via JNI) to encode them to Arrow IPC format.
Uses Spark’s partitioner for partition assignment. Can accept either row-based or columnar input
(columnar input is converted to rows via <code class="docutils literal notranslate"><span class="pre">ColumnarToRowExec</span></code>).</p></li>
</ul>
<p>The JVM shuffle is selected via <code class="docutils literal notranslate"><span class="pre">CometShuffleDependency.shuffleType</span></code>.</p>
</section>
<section id="when-jvm-shuffle-is-used">
<h2>When JVM Shuffle is Used<a class="headerlink" href="#when-jvm-shuffle-is-used" title="Link to this heading">#</a></h2>
<p>JVM shuffle (<code class="docutils literal notranslate"><span class="pre">CometColumnarExchange</span></code>) is used instead of native shuffle (<code class="docutils literal notranslate"><span class="pre">CometExchange</span></code>) in the following cases:</p>
<ol class="arabic simple">
<li><p><strong>Shuffle mode is explicitly set to “jvm”</strong>: When <code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.mode</span></code> is set to <code class="docutils literal notranslate"><span class="pre">jvm</span></code>.</p></li>
<li><p><strong>Child plan is not a Comet native operator</strong>: When the child plan is a Spark row-based operator
(not a <code class="docutils literal notranslate"><span class="pre">CometPlan</span></code>), JVM shuffle is the only option since native shuffle requires columnar input
from Comet operators.</p></li>
<li><p><strong>Unsupported partitioning type</strong>: Native shuffle only supports <code class="docutils literal notranslate"><span class="pre">HashPartitioning</span></code>, <code class="docutils literal notranslate"><span class="pre">RangePartitioning</span></code>,
and <code class="docutils literal notranslate"><span class="pre">SinglePartition</span></code>. JVM shuffle additionally supports <code class="docutils literal notranslate"><span class="pre">RoundRobinPartitioning</span></code>.</p></li>
<li><p><strong>Unsupported partition key types</strong>: For <code class="docutils literal notranslate"><span class="pre">HashPartitioning</span></code> and <code class="docutils literal notranslate"><span class="pre">RangePartitioning</span></code>, native shuffle
only supports primitive types as partition keys. Complex types (struct, array, map) cannot be used
as partition keys in native shuffle, though they are fully supported as data columns in both implementations.</p></li>
</ol>
</section>
<section id="input-handling">
<h2>Input Handling<a class="headerlink" href="#input-handling" title="Link to this heading">#</a></h2>
<section id="spark-row-based-input">
<h3>Spark Row-Based Input<a class="headerlink" href="#spark-row-based-input" title="Link to this heading">#</a></h3>
<p>When the child plan is a Spark row-based operator, <code class="docutils literal notranslate"><span class="pre">CometColumnarExchange</span></code> calls <code class="docutils literal notranslate"><span class="pre">child.execute()</span></code> which
returns an <code class="docutils literal notranslate"><span class="pre">RDD[InternalRow]</span></code>. The rows flow directly to the JVM shuffle writers.</p>
</section>
<section id="comet-columnar-input">
<h3>Comet Columnar Input<a class="headerlink" href="#comet-columnar-input" title="Link to this heading">#</a></h3>
<p>When the child plan is a Comet native operator (e.g., <code class="docutils literal notranslate"><span class="pre">CometHashAggregate</span></code>) but JVM shuffle is selected
(due to shuffle mode setting or unsupported partitioning), <code class="docutils literal notranslate"><span class="pre">CometColumnarExchange</span></code> still calls
<code class="docutils literal notranslate"><span class="pre">child.execute()</span></code>. Comet operators implement <code class="docutils literal notranslate"><span class="pre">doExecute()</span></code> by wrapping themselves with <code class="docutils literal notranslate"><span class="pre">ColumnarToRowExec</span></code>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// In CometExec base class</span>
<span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doExecute</span><span class="p">():</span><span class="w"> </span><span class="nc">RDD</span><span class="p">[</span><span class="nc">InternalRow</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nc">ColumnarToRowExec</span><span class="p">(</span><span class="bp">this</span><span class="p">).</span><span class="n">doExecute</span><span class="p">()</span>
</pre></div>
</div>
<p>This means the data path becomes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Comet Native (columnar) → ColumnarToRowExec → rows → JVM Shuffle → Arrow IPC → columnar
</pre></div>
</div>
<p>This is less efficient than native shuffle which avoids the columnar-to-row conversion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Comet Native (columnar) → Native Shuffle → Arrow IPC → columnar
</pre></div>
</div>
</section>
<section id="why-use-spark-s-partitioner">
<h3>Why Use Spark’s Partitioner?<a class="headerlink" href="#why-use-spark-s-partitioner" title="Link to this heading">#</a></h3>
<p>JVM shuffle uses row-based input so it can leverage Spark’s existing partitioner infrastructure
(<code class="docutils literal notranslate"><span class="pre">partitioner.getPartition(key)</span></code>). This allows Comet to support all of Spark’s partitioning schemes
without reimplementing them in Rust. Native shuffle, by contrast, serializes the partitioning scheme
to protobuf and implements the partitioning logic in native code.</p>
</section>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌─────────────────────────────────────────────────────────────────────────┐
│                         CometShuffleManager                             │
│  - Extends Spark&#39;s ShuffleManager                                       │
│  - Routes to appropriate writer/reader based on ShuffleHandle type      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
           ┌────────────────────────┼────────────────────────┐
           ▼                        ▼                        ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│ CometBypassMerge-   │  │ CometUnsafe-        │  │ CometNative-        │
│ SortShuffleWriter   │  │ ShuffleWriter       │  │ ShuffleWriter       │
│ (hash-based)        │  │ (sort-based)        │  │ (fully native)      │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
           │                        │
           ▼                        ▼
┌─────────────────────┐  ┌─────────────────────┐
│ CometDiskBlock-     │  │ CometShuffleExternal│
│ Writer              │  │ Sorter              │
└─────────────────────┘  └─────────────────────┘
           │                        │
           └────────────┬───────────┘
                        ▼
              ┌─────────────────────┐
              │ SpillWriter         │
              │ (native encoding    │
              │  via JNI)           │
              └─────────────────────┘
</pre></div>
</div>
</section>
<section id="key-classes">
<h2>Key Classes<a class="headerlink" href="#key-classes" title="Link to this heading">#</a></h2>
<section id="shuffle-manager">
<h3>Shuffle Manager<a class="headerlink" href="#shuffle-manager" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Location</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CometShuffleManager</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/CometShuffleManager.scala</span></code></p></td>
<td><p>Entry point. Extends Spark’s <code class="docutils literal notranslate"><span class="pre">ShuffleManager</span></code>. Selects writer/reader based on handle type. Delegates non-Comet shuffles to <code class="docutils literal notranslate"><span class="pre">SortShuffleManager</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CometShuffleDependency</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/CometShuffleDependency.scala</span></code></p></td>
<td><p>Extends <code class="docutils literal notranslate"><span class="pre">ShuffleDependency</span></code>. Contains <code class="docutils literal notranslate"><span class="pre">shuffleType</span></code> (<code class="docutils literal notranslate"><span class="pre">CometColumnarShuffle</span></code> or <code class="docutils literal notranslate"><span class="pre">CometNativeShuffle</span></code>) and schema info.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="shuffle-handles">
<h3>Shuffle Handles<a class="headerlink" href="#shuffle-handles" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Handle</p></th>
<th class="head"><p>Writer Strategy</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CometBypassMergeSortShuffleHandle</span></code></p></td>
<td><p>Hash-based: one file per partition, merged at end</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CometSerializedShuffleHandle</span></code></p></td>
<td><p>Sort-based: records sorted by partition ID, single output</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CometNativeShuffleHandle</span></code></p></td>
<td><p>Fully native shuffle</p></td>
</tr>
</tbody>
</table>
</div>
<p>Selection logic in <code class="docutils literal notranslate"><span class="pre">CometShuffleManager.shouldBypassMergeSort()</span></code>:</p>
<ul class="simple">
<li><p>Uses bypass if partitions &lt; threshold AND partitions × cores ≤ max threads</p></li>
<li><p>Otherwise uses sort-based to avoid OOM from many concurrent writers</p></li>
</ul>
</section>
<section id="writers">
<h3>Writers<a class="headerlink" href="#writers" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Location</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CometBypassMergeSortShuffleWriter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/CometBypassMergeSortShuffleWriter.java</span></code></p></td>
<td><p>Hash-based writer. Creates one <code class="docutils literal notranslate"><span class="pre">CometDiskBlockWriter</span></code> per partition. Supports async writes.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CometUnsafeShuffleWriter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/CometUnsafeShuffleWriter.java</span></code></p></td>
<td><p>Sort-based writer. Uses <code class="docutils literal notranslate"><span class="pre">CometShuffleExternalSorter</span></code> to buffer and sort records, then merges spill files.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CometDiskBlockWriter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/CometDiskBlockWriter.java</span></code></p></td>
<td><p>Buffers rows in memory pages for a single partition. Spills to disk via native encoding. Used by bypass writer.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CometShuffleExternalSorter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/sort/CometShuffleExternalSorter.java</span></code></p></td>
<td><p>Buffers records across all partitions, sorts by partition ID, spills sorted data. Used by unsafe writer.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SpillWriter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/SpillWriter.java</span></code></p></td>
<td><p>Base class for spill logic. Manages memory pages and calls <code class="docutils literal notranslate"><span class="pre">Native.writeSortedFileNative()</span></code> for Arrow IPC encoding.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="reader">
<h3>Reader<a class="headerlink" href="#reader" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Location</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CometBlockStoreShuffleReader</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/CometBlockStoreShuffleReader.scala</span></code></p></td>
<td><p>Fetches shuffle blocks via <code class="docutils literal notranslate"><span class="pre">ShuffleBlockFetcherIterator</span></code>. Decodes Arrow IPC to <code class="docutils literal notranslate"><span class="pre">ColumnarBatch</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">NativeBatchDecoderIterator</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.../shuffle/NativeBatchDecoderIterator.scala</span></code></p></td>
<td><p>Reads compressed Arrow IPC batches from input stream. Calls <code class="docutils literal notranslate"><span class="pre">Native.decodeShuffleBlock()</span></code> via JNI.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="data-flow">
<h2>Data Flow<a class="headerlink" href="#data-flow" title="Link to this heading">#</a></h2>
<section id="write-path">
<h3>Write Path<a class="headerlink" href="#write-path" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ShuffleWriteProcessor</span></code> calls <code class="docutils literal notranslate"><span class="pre">CometShuffleManager.getWriter()</span></code></p></li>
<li><p>Writer receives <code class="docutils literal notranslate"><span class="pre">Iterator[Product2[K,</span> <span class="pre">V]]</span></code> where V is <code class="docutils literal notranslate"><span class="pre">UnsafeRow</span></code></p></li>
<li><p>Rows are serialized and buffered in off-heap memory pages</p></li>
<li><p>When memory threshold or batch size is reached, <code class="docutils literal notranslate"><span class="pre">SpillWriter.doSpilling()</span></code> is called</p></li>
<li><p>Native code (<code class="docutils literal notranslate"><span class="pre">Native.writeSortedFileNative()</span></code>) converts rows to Arrow arrays and writes IPC format</p></li>
<li><p>For bypass writer: partition files are concatenated into final output</p></li>
<li><p>For sort writer: spill files are merged</p></li>
</ol>
</section>
<section id="read-path">
<h3>Read Path<a class="headerlink" href="#read-path" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CometBlockStoreShuffleReader.read()</span></code> creates <code class="docutils literal notranslate"><span class="pre">ShuffleBlockFetcherIterator</span></code></p></li>
<li><p>For each block, <code class="docutils literal notranslate"><span class="pre">NativeBatchDecoderIterator</span></code> reads the IPC stream</p></li>
<li><p>Native code (<code class="docutils literal notranslate"><span class="pre">Native.decodeShuffleBlock()</span></code>) decompresses and decodes to Arrow arrays</p></li>
<li><p>Arrow FFI imports arrays as <code class="docutils literal notranslate"><span class="pre">ColumnarBatch</span></code></p></li>
</ol>
</section>
</section>
<section id="memory-management">
<h2>Memory Management<a class="headerlink" href="#memory-management" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CometShuffleMemoryAllocator</span></code>: Custom allocator for off-heap memory pages</p></li>
<li><p>Memory is allocated in pages; when allocation fails, writers spill to disk</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CometDiskBlockWriter</span></code> coordinates spilling across all partition writers (largest first)</p></li>
<li><p>Async spilling is supported via <code class="docutils literal notranslate"><span class="pre">ShuffleThreadPool</span></code></p></li>
</ul>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Config</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">spark.comet.columnar.shuffle.async.enabled</span></code></p></td>
<td><p>Enable async spill writes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">spark.comet.columnar.shuffle.async.thread.num</span></code></p></td>
<td><p>Threads per writer for async</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">spark.comet.columnar.shuffle.batch.size</span></code></p></td>
<td><p>Rows per Arrow batch</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">spark.comet.columnar.shuffle.spill.threshold</span></code></p></td>
<td><p>Row count threshold for spill</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">spark.comet.exec.shuffle.compression.codec</span></code></p></td>
<td><p>Compression codec (zstd, lz4, etc.)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ffi.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Arrow FFI Usage in Comet</p>
      </div>
    </a>
    <a class="right-next"
       href="native_shuffle.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Native Shuffle</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p>Apache DataFusion, Apache DataFusion Comet, Apache, the Apache feather logo, and the Apache DataFusion project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>