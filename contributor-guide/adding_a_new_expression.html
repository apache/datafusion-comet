<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->


<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Adding a New Expression &#8212; Apache DataFusion Comet  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=cd442bcd" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'contributor-guide/adding_a_new_expression';</script>
    <script async="true" defer="true" src="https://buttons.github.io/buttons.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tracing" href="tracing.html" />
    <link rel="prev" title="Adding a New Operator" href="adding_a_new_operator.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/DataFusionComet-Logo-Light.png" class="logo__image only-light" alt="Apache DataFusion Comet  documentation - Home"/>
    <img src="../_static/DataFusionComet-Logo-Dark.png" class="logo__image only-dark pst-js-only" alt="Apache DataFusion Comet  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    Comet Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user-guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../asf/index.html">
    ASF Links
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/apache/datafusion-comet" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    Comet Overview
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user-guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../asf/index.html">
    ASF Links
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/apache/datafusion-comet" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p aria-level="2" class="caption" role="heading"><span class="caption-text">Index</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">Comet Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Contributor Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin_overview.html">Comet Plugin Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin_overview.html#plugin-components">Plugin Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="ffi.html">Arrow FFI</a></li>
<li class="toctree-l2"><a class="reference internal" href="jvm_shuffle.html">JVM Shuffle</a></li>
<li class="toctree-l2"><a class="reference internal" href="native_shuffle.html">Native Shuffle</a></li>
<li class="toctree-l2"><a class="reference internal" href="parquet_scans.html">Parquet Scans</a></li>
<li class="toctree-l2"><a class="reference internal" href="development.html">Development Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Debugging Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmarking.html">Benchmarking Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_new_operator.html">Adding a New Operator</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding a New Expression</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="profiling_native_code.html">Profiling Native Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="spark-sql-tests.html">Spark SQL Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="sql-file-tests.html">SQL File Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="release_process.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference external" href="https://github.com/apache/datafusion-comet">Github and Issue Tracker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../asf/index.html">ASF Links</a></li>
</ul>

  </div>
</nav>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Comet Contributor Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Adding a New Expression</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <!---
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
<section id="adding-a-new-expression">
<h1>Adding a New Expression<a class="headerlink" href="#adding-a-new-expression" title="Link to this heading">#</a></h1>
<p>There are a number of Spark expression that are not supported by DataFusion Comet yet, and implementing them is a good way to contribute to the project.</p>
<p>Before you start, have a look through <a class="reference external" href="https://docs.google.com/presentation/d/1H0fF2MOkkBK8fPBlnqK6LejUeLcVD917JhVWfp3mb8A/edit#slide=id.p">these slides</a> as they provide a conceptual overview. And a video of a presentation on those slides is available <a class="reference external" href="https://drive.google.com/file/d/1POU4lFAZfYwZR8zV1X2eoLiAmc1GDtSP/view?usp=sharing">here</a>.</p>
<section id="finding-an-expression-to-add">
<h2>Finding an Expression to Add<a class="headerlink" href="#finding-an-expression-to-add" title="Link to this heading">#</a></h2>
<p>You may have a specific expression in mind that you’d like to add, but if not, you can review the <a class="reference external" href="https://github.com/apache/datafusion-comet/blob/main/docs/spark_expressions_support.md">expression coverage document</a> to see which expressions are not yet supported.</p>
</section>
<section id="implementing-the-expression">
<h2>Implementing the Expression<a class="headerlink" href="#implementing-the-expression" title="Link to this heading">#</a></h2>
<p>Once you have the expression you’d like to add, you should take inventory of the following:</p>
<ol class="arabic simple">
<li><p>What is the Spark expression’s behavior across different Spark versions? These make good test cases and will inform you of any compatibility issues, such as an API change that will have to be addressed.</p></li>
<li><p>Check if the expression is already implemented in DataFusion and if it is compatible with the Spark expression.</p>
<ol class="arabic simple">
<li><p>If it is, you can potentially reuse the existing implementation though you’ll need to add tests to verify compatibility.</p></li>
<li><p>If it’s not, consider an initial version in DataFusion for expressions that are common across different engines. For expressions that are specific to Spark, consider an initial version in DataFusion Comet.</p></li>
</ol>
</li>
<li><p>Test cases for the expression. As mentioned, you can refer to Spark’s test cases for a good idea of what to test.</p></li>
</ol>
<p>Once you know what you want to add, you’ll need to update the query planner to recognize the new expression in Scala and potentially add a new expression implementation in the Rust package.</p>
<section id="adding-the-expression-in-scala">
<h3>Adding the Expression in Scala<a class="headerlink" href="#adding-the-expression-in-scala" title="Link to this heading">#</a></h3>
<p>DataFusion Comet uses a framework based on the <code class="docutils literal notranslate"><span class="pre">CometExpressionSerde</span></code> trait for converting Spark expressions to protobuf. Instead of a large match statement, each expression type has its own serialization handler. For aggregate expressions, use the <code class="docutils literal notranslate"><span class="pre">CometAggregateExpressionSerde</span></code> trait instead.</p>
<section id="creating-a-cometexpressionserde-implementation">
<h4>Creating a CometExpressionSerde Implementation<a class="headerlink" href="#creating-a-cometexpressionserde-implementation" title="Link to this heading">#</a></h4>
<p>First, create an object that extends <code class="docutils literal notranslate"><span class="pre">CometExpressionSerde[T]</span></code> where <code class="docutils literal notranslate"><span class="pre">T</span></code> is the Spark expression type. This is typically added to one of the serde files in <code class="docutils literal notranslate"><span class="pre">spark/src/main/scala/org/apache/comet/serde/</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">math.scala</span></code>, <code class="docutils literal notranslate"><span class="pre">strings.scala</span></code>, <code class="docutils literal notranslate"><span class="pre">arrays.scala</span></code>, etc.).</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">unhex</span></code> function looks like this:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">CometUnhex</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">CometExpressionSerde</span><span class="p">[</span><span class="nc">Unhex</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span>
<span class="w">      </span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Unhex</span><span class="p">,</span>
<span class="w">      </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Attribute</span><span class="p">],</span>
<span class="w">      </span><span class="n">binding</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">ExprOuterClass</span><span class="p">.</span><span class="nc">Expr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">childExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exprToProtoInternal</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">binding</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">failOnErrorExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exprToProtoInternal</span><span class="p">(</span><span class="nc">Literal</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">failOnError</span><span class="p">),</span><span class="w"> </span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">binding</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">optExpr</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">scalarFunctionExprToProtoWithReturnType</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;unhex&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">expr</span><span class="p">.</span><span class="n">dataType</span><span class="p">,</span>
<span class="w">        </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="n">childExpr</span><span class="p">,</span>
<span class="w">        </span><span class="n">failOnErrorExpr</span><span class="p">)</span>
<span class="w">    </span><span class="n">optExprWithInfo</span><span class="p">(</span><span class="n">optExpr</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="n">child</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">CometExpressionSerde</span></code> trait provides three methods you can override:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">convert(expr:</span> <span class="pre">T,</span> <span class="pre">inputs:</span> <span class="pre">Seq[Attribute],</span> <span class="pre">binding:</span> <span class="pre">Boolean):</span> <span class="pre">Option[Expr]</span></code> - <strong>Required</strong>. Converts the Spark expression to protobuf. Return <code class="docutils literal notranslate"><span class="pre">None</span></code> if the expression cannot be converted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getSupportLevel(expr:</span> <span class="pre">T):</span> <span class="pre">SupportLevel</span></code> - Optional. Returns the level of support for the expression. See “Using getSupportLevel” section below for details.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getExprConfigName(expr:</span> <span class="pre">T):</span> <span class="pre">String</span></code> - Optional. Returns a short name for configuration keys. Defaults to the Spark class name.</p></li>
</ul>
<p>For simple scalar functions that map directly to a DataFusion function, you can use the built-in <code class="docutils literal notranslate"><span class="pre">CometScalarFunction</span></code> implementation:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">classOf</span><span class="p">[</span><span class="nc">Cos</span><span class="p">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">CometScalarFunction</span><span class="p">(</span><span class="s">&quot;cos&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="registering-the-expression-handler">
<h4>Registering the Expression Handler<a class="headerlink" href="#registering-the-expression-handler" title="Link to this heading">#</a></h4>
<p>Once you’ve created your <code class="docutils literal notranslate"><span class="pre">CometExpressionSerde</span></code> implementation, register it in <code class="docutils literal notranslate"><span class="pre">QueryPlanSerde.scala</span></code> by adding it to the appropriate expression map (e.g., <code class="docutils literal notranslate"><span class="pre">mathExpressions</span></code>, <code class="docutils literal notranslate"><span class="pre">stringExpressions</span></code>, <code class="docutils literal notranslate"><span class="pre">predicateExpressions</span></code>, etc.):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">mathExpressions</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">Class</span><span class="p">[</span><span class="n">_</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Expression</span><span class="p">],</span><span class="w"> </span><span class="nc">CometExpressionSerde</span><span class="p">[</span><span class="n">_</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span>
<span class="w">  </span><span class="c1">// ... other expressions ...</span>
<span class="w">  </span><span class="k">classOf</span><span class="p">[</span><span class="nc">Unhex</span><span class="p">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">CometUnhex</span><span class="p">,</span>
<span class="w">  </span><span class="k">classOf</span><span class="p">[</span><span class="nc">Hex</span><span class="p">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">CometHex</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">exprToProtoInternal</span></code> method will automatically use this mapping to find and invoke your handler when it encounters the corresponding Spark expression type.</p>
<p>A few things to note:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">convert</span></code> method is recursively called on child expressions using <code class="docutils literal notranslate"><span class="pre">exprToProtoInternal</span></code>, so you’ll need to make sure that the child expressions are also converted to protobuf.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scalarFunctionExprToProtoWithReturnType</span></code> is for scalar functions that need to return type information. Your expression may use a different method depending on the type of expression.</p></li>
<li><p>Use helper methods like <code class="docutils literal notranslate"><span class="pre">createBinaryExpr</span></code> and <code class="docutils literal notranslate"><span class="pre">createUnaryExpr</span></code> from <code class="docutils literal notranslate"><span class="pre">QueryPlanSerde</span></code> for common expression patterns.</p></li>
</ul>
</section>
<section id="using-getsupportlevel">
<h4>Using getSupportLevel<a class="headerlink" href="#using-getsupportlevel" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">getSupportLevel</span></code> method allows you to control whether an expression should be executed by Comet based on various conditions such as data types, parameter values, or other expression-specific constraints. This is particularly useful when:</p>
<ol class="arabic simple">
<li><p>Your expression only supports specific data types</p></li>
<li><p>Your expression has known incompatibilities with Spark’s behavior</p></li>
<li><p>Your expression has edge cases that aren’t yet supported</p></li>
</ol>
<p>The method returns one of three <code class="docutils literal notranslate"><span class="pre">SupportLevel</span></code> values:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">Compatible(notes:</span> <span class="pre">Option[String]</span> <span class="pre">=</span> <span class="pre">None)</span></code></strong> - Comet supports this expression with full compatibility with Spark, or may have known differences in specific edge cases that are unlikely to be an issue for most users. This is the default if you don’t override <code class="docutils literal notranslate"><span class="pre">getSupportLevel</span></code>.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">Incompatible(notes:</span> <span class="pre">Option[String]</span> <span class="pre">=</span> <span class="pre">None)</span></code></strong> - Comet supports this expression but results can be different from Spark. The expression will only be used if <code class="docutils literal notranslate"><span class="pre">spark.comet.expr.allowIncompatible=true</span></code> or the expression-specific config <code class="docutils literal notranslate"><span class="pre">spark.comet.expr.&lt;exprName&gt;.allowIncompatible=true</span></code> is set.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">Unsupported(notes:</span> <span class="pre">Option[String]</span> <span class="pre">=</span> <span class="pre">None)</span></code></strong> - Comet does not support this expression under the current conditions. The expression will not be used and Spark will fall back to its native execution.</p></li>
</ul>
<p>All three support levels accept an optional <code class="docutils literal notranslate"><span class="pre">notes</span></code> parameter to provide additional context about the support level.</p>
<section id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h5>
<p><strong>Example 1: Restricting to specific data types</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">Abs</span></code> expression only supports numeric types:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">CometAbs</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">CometExpressionSerde</span><span class="p">[</span><span class="nc">Abs</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getSupportLevel</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Abs</span><span class="p">):</span><span class="w"> </span><span class="nc">SupportLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">expr</span><span class="p">.</span><span class="n">child</span><span class="p">.</span><span class="n">dataType</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_:</span><span class="w"> </span><span class="nc">NumericType</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="nc">Compatible</span><span class="p">()</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="c1">// Spark supports NumericType, DayTimeIntervalType, and YearMonthIntervalType</span>
<span class="w">        </span><span class="nc">Unsupported</span><span class="p">(</span><span class="nc">Some</span><span class="p">(</span><span class="s">&quot;Only integral, floating-point, and decimal types are supported&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span>
<span class="w">      </span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Abs</span><span class="p">,</span>
<span class="w">      </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Attribute</span><span class="p">],</span>
<span class="w">      </span><span class="n">binding</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">ExprOuterClass</span><span class="p">.</span><span class="nc">Expr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... conversion logic ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example 2: Validating parameter values</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">TruncDate</span></code> expression only supports specific format strings:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">CometTruncDate</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">CometExpressionSerde</span><span class="p">[</span><span class="nc">TruncDate</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">supportedFormats</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">Seq</span><span class="p">(</span><span class="s">&quot;year&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;yyyy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;yy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;quarter&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mon&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;month&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;week&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getSupportLevel</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">TruncDate</span><span class="p">):</span><span class="w"> </span><span class="nc">SupportLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">expr</span><span class="p">.</span><span class="n">format</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Literal</span><span class="p">(</span><span class="n">fmt</span><span class="p">:</span><span class="w"> </span><span class="nc">UTF8String</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">supportedFormats</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">fmt</span><span class="p">.</span><span class="n">toString</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ROOT</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nc">Compatible</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nc">Unsupported</span><span class="p">(</span><span class="nc">Some</span><span class="p">(</span><span class="s">s&quot;Format </span><span class="si">$</span><span class="n">fmt</span><span class="s"> is not supported&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="nc">Incompatible</span><span class="p">(</span>
<span class="w">          </span><span class="nc">Some</span><span class="p">(</span><span class="s">&quot;Invalid format strings will throw an exception instead of returning NULL&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span>
<span class="w">      </span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">TruncDate</span><span class="p">,</span>
<span class="w">      </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Attribute</span><span class="p">],</span>
<span class="w">      </span><span class="n">binding</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">ExprOuterClass</span><span class="p">.</span><span class="nc">Expr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... conversion logic ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example 3: Marking known incompatibilities</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">ArrayAppend</span></code> expression has known behavioral differences from Spark:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">CometArrayAppend</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">CometExpressionSerde</span><span class="p">[</span><span class="nc">ArrayAppend</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getSupportLevel</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">ArrayAppend</span><span class="p">):</span><span class="w"> </span><span class="nc">SupportLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Incompatible</span><span class="p">(</span><span class="nc">None</span><span class="p">)</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span>
<span class="w">      </span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">ArrayAppend</span><span class="p">,</span>
<span class="w">      </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Attribute</span><span class="p">],</span>
<span class="w">      </span><span class="n">binding</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">ExprOuterClass</span><span class="p">.</span><span class="nc">Expr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... conversion logic ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This expression will only be used when users explicitly enable incompatible expressions via configuration.</p>
</section>
<section id="how-getsupportlevel-affects-execution">
<h5>How getSupportLevel Affects Execution<a class="headerlink" href="#how-getsupportlevel-affects-execution" title="Link to this heading">#</a></h5>
<p>When the query planner encounters an expression:</p>
<ol class="arabic simple">
<li><p>It first checks if the expression is explicitly disabled via <code class="docutils literal notranslate"><span class="pre">spark.comet.expr.&lt;exprName&gt;.enabled=false</span></code></p></li>
<li><p>It then calls <code class="docutils literal notranslate"><span class="pre">getSupportLevel</span></code> on the expression handler</p></li>
<li><p>Based on the result:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Compatible()</span></code>: Expression proceeds to conversion</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Incompatible()</span></code>: Expression is skipped unless <code class="docutils literal notranslate"><span class="pre">spark.comet.expr.allowIncompatible=true</span></code> or expression-specific allow config is set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Unsupported()</span></code>: Expression is skipped and a fallback to Spark occurs</p></li>
</ul>
</li>
</ol>
<p>Any notes provided will be logged to help with debugging and understanding why an expression was not used.</p>
</section>
</section>
<section id="adding-spark-side-tests-for-the-new-expression">
<h4>Adding Spark-side Tests for the New Expression<a class="headerlink" href="#adding-spark-side-tests-for-the-new-expression" title="Link to this heading">#</a></h4>
<p>It is important to verify that the new expression is correctly recognized by the native execution engine and matches the expected spark behavior. To do this, you can add a set of test cases in the <code class="docutils literal notranslate"><span class="pre">CometExpressionSuite</span></code>, and use the <code class="docutils literal notranslate"><span class="pre">checkSparkAnswerAndOperator</span></code> method to compare the results of the new expression with the expected Spark results and that Comet’s native execution engine is able to execute the expression.</p>
<p>For example, this is the test case for the <code class="docutils literal notranslate"><span class="pre">unhex</span></code> expression:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">(</span><span class="s">&quot;unhex&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;unhex_table&quot;</span>
<span class="w">  </span><span class="n">withTable</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sql</span><span class="p">(</span><span class="s">s&quot;create table </span><span class="si">$</span><span class="n">table</span><span class="s">(col string) using parquet&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">sql</span><span class="p">(</span><span class="s">s&quot;&quot;&quot;INSERT INTO </span><span class="si">$</span><span class="n">table</span><span class="s"> VALUES</span>
<span class="s">      |(&#39;537061726B2053514C&#39;),</span>
<span class="s">      |(&#39;737472696E67&#39;),</span>
<span class="s">      |(&#39;\\0&#39;),</span>
<span class="s">      |(&#39;&#39;),</span>
<span class="s">      |(&#39;###&#39;),</span>
<span class="s">      |(&#39;G123&#39;),</span>
<span class="s">      |(&#39;hello&#39;),</span>
<span class="s">      |(&#39;A1B&#39;),</span>
<span class="s">      |(&#39;0A1B&#39;)&quot;&quot;&quot;</span><span class="p">.</span><span class="n">stripMargin</span><span class="p">)</span>

<span class="w">    </span><span class="n">checkSparkAnswerAndOperator</span><span class="p">(</span><span class="s">s&quot;SELECT unhex(col) FROM </span><span class="si">$</span><span class="n">table</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-with-literal-values">
<h4>Testing with Literal Values<a class="headerlink" href="#testing-with-literal-values" title="Link to this heading">#</a></h4>
<p>When writing tests that use literal values (e.g., <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">my_func('literal')</span></code>), Spark’s constant folding optimizer may evaluate the expression at planning time rather than execution time. This means your Comet implementation might not actually be exercised during the test.</p>
<p>To ensure literal expressions are executed by Comet, disable the constant folding optimizer:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">(</span><span class="s">&quot;my_func with literals&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">withSQLConf</span><span class="p">(</span><span class="nc">SQLConf</span><span class="p">.</span><span class="nc">OPTIMIZER_EXCLUDED_RULES</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="s">&quot;org.apache.spark.sql.catalyst.optimizer.ConstantFolding&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">checkSparkAnswerAndOperator</span><span class="p">(</span><span class="s">&quot;SELECT my_func(&#39;literal_value&#39;)&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is particularly important for:</p>
<ul class="simple">
<li><p>Edge case tests using specific literal values (e.g., null handling, overflow conditions)</p></li>
<li><p>Tests verifying behavior with special input values</p></li>
<li><p>Any test where the expression inputs are entirely literal</p></li>
</ul>
<p>When possible, prefer testing with column references from tables (as shown in the <code class="docutils literal notranslate"><span class="pre">unhex</span></code> example above), which naturally avoids the constant folding issue.</p>
</section>
</section>
<section id="adding-the-expression-to-the-protobuf-definition">
<h3>Adding the Expression To the Protobuf Definition<a class="headerlink" href="#adding-the-expression-to-the-protobuf-definition" title="Link to this heading">#</a></h3>
<p>Once you have the expression implemented in Scala, you might need to update the protobuf definition to include the new expression. You may not need to do this if the expression is already covered by the existing protobuf definition (e.g. you’re adding a new scalar function that uses the <code class="docutils literal notranslate"><span class="pre">ScalarFunc</span></code> message).</p>
<p>You can find the protobuf definition in <code class="docutils literal notranslate"><span class="pre">native/proto/src/proto/expr.proto</span></code>, and in particular the <code class="docutils literal notranslate"><span class="pre">Expr</span></code> or potentially the <code class="docutils literal notranslate"><span class="pre">AggExpr</span></code> messages. If you were to add a new expression called <code class="docutils literal notranslate"><span class="pre">Add2</span></code>, you would add a new case to the <code class="docutils literal notranslate"><span class="pre">Expr</span></code> message like so:</p>
<div class="highlight-proto notranslate"><div class="highlight"><pre><span></span><span class="kd">message</span><span class="w"> </span><span class="nc">Expr</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">oneof</span><span class="w"> </span><span class="n">expr_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="n">Add2</span><span class="w"> </span><span class="na">add2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="c1">// Choose the next available number</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then you would define the <code class="docutils literal notranslate"><span class="pre">Add2</span></code> message like so:</p>
<div class="highlight-proto notranslate"><div class="highlight"><pre><span></span><span class="kd">message</span><span class="w"> </span><span class="nc">Add2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Expr</span><span class="w"> </span><span class="na">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">Expr</span><span class="w"> </span><span class="na">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="adding-the-expression-in-rust">
<h3>Adding the Expression in Rust<a class="headerlink" href="#adding-the-expression-in-rust" title="Link to this heading">#</a></h3>
<p>With the serialization complete, the next step is to implement the expression in Rust and ensure that the incoming plan can make use of it.</p>
<p>How this works is somewhat dependent on the type of expression you’re adding. Expression implementations live in the <code class="docutils literal notranslate"><span class="pre">native/spark-expr/src/</span></code> directory, organized by category (e.g., <code class="docutils literal notranslate"><span class="pre">math_funcs/</span></code>, <code class="docutils literal notranslate"><span class="pre">string_funcs/</span></code>, <code class="docutils literal notranslate"><span class="pre">array_funcs/</span></code>).</p>
<section id="generally-adding-a-new-expression">
<h4>Generally Adding a New Expression<a class="headerlink" href="#generally-adding-a-new-expression" title="Link to this heading">#</a></h4>
<p>If you’re adding a new expression that requires custom protobuf serialization, you may need to:</p>
<ol class="arabic simple">
<li><p>Add a new message to the protobuf definition in <code class="docutils literal notranslate"><span class="pre">native/proto/src/proto/expr.proto</span></code></p></li>
<li><p>Add a native expression handler in <code class="docutils literal notranslate"><span class="pre">expression_registry.rs</span></code> to deserialize the new protobuf message type and
create a native expression</p></li>
</ol>
<p>For most expressions, you can skip this step if you’re using the existing scalar function infrastructure.</p>
</section>
<section id="adding-a-new-scalar-function-expression">
<h4>Adding a New Scalar Function Expression<a class="headerlink" href="#adding-a-new-scalar-function-expression" title="Link to this heading">#</a></h4>
<p>For a new scalar function, you can reuse a lot of code by updating the <code class="docutils literal notranslate"><span class="pre">create_comet_physical_fun</span></code> method in <code class="docutils literal notranslate"><span class="pre">native/spark-expr/src/comet_scalar_funcs.rs</span></code>. Add a match case for your function name:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">match</span><span class="w"> </span><span class="n">fun_name</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... other functions ...</span>
<span class="w">    </span><span class="s">&quot;unhex&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">spark_unhex</span><span class="p">);</span>
<span class="w">        </span><span class="n">make_comet_scalar_udf</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;unhex&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ... more functions ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">make_comet_scalar_udf!</span></code> macro has several variants depending on whether your function needs:</p>
<ul class="simple">
<li><p>A data type parameter: <code class="docutils literal notranslate"><span class="pre">make_comet_scalar_udf!(&quot;ceil&quot;,</span> <span class="pre">spark_ceil,</span> <span class="pre">data_type)</span></code></p></li>
<li><p>No data type parameter: <code class="docutils literal notranslate"><span class="pre">make_comet_scalar_udf!(&quot;unhex&quot;,</span> <span class="pre">func,</span> <span class="pre">without</span> <span class="pre">data_type)</span></code></p></li>
<li><p>An eval mode: <code class="docutils literal notranslate"><span class="pre">make_comet_scalar_udf!(&quot;decimal_div&quot;,</span> <span class="pre">spark_decimal_div,</span> <span class="pre">data_type,</span> <span class="pre">eval_mode)</span></code></p></li>
<li><p>A fail_on_error flag: <code class="docutils literal notranslate"><span class="pre">make_comet_scalar_udf!(&quot;spark_modulo&quot;,</span> <span class="pre">func,</span> <span class="pre">without</span> <span class="pre">data_type,</span> <span class="pre">fail_on_error)</span></code></p></li>
</ul>
</section>
<section id="implementing-the-function">
<h4>Implementing the Function<a class="headerlink" href="#implementing-the-function" title="Link to this heading">#</a></h4>
<p>Then implement your function in an appropriate module under <code class="docutils literal notranslate"><span class="pre">native/spark-expr/src/</span></code>. The function signature will look like:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">spark_unhex</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">ColumnarValue</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">ColumnarValue</span><span class="p">,</span><span class="w"> </span><span class="n">DataFusionError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Do the work here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If your function uses the data type or eval mode, the signature will include those as additional parameters:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">spark_ceil</span><span class="p">(</span>
<span class="w">    </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">ColumnarValue</span><span class="p">],</span>
<span class="w">    </span><span class="n">data_type</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">DataType</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">ColumnarValue</span><span class="p">,</span><span class="w"> </span><span class="n">DataFusionError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implementation</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="api-differences-between-spark-versions">
<h3>API Differences Between Spark Versions<a class="headerlink" href="#api-differences-between-spark-versions" title="Link to this heading">#</a></h3>
<p>If the expression you’re adding has different behavior across different Spark versions, you’ll need to account for that in your implementation. There are two tools at your disposal to help with this:</p>
<ol class="arabic simple">
<li><p>Shims that exist in <code class="docutils literal notranslate"><span class="pre">spark/src/main/spark-$SPARK_VERSION/org/apache/comet/shims/CometExprShim.scala</span></code> for each Spark version. These shims are used to provide compatibility between different Spark versions.</p></li>
<li><p>Variables that correspond to the Spark version, such as <code class="docutils literal notranslate"><span class="pre">isSpark33Plus</span></code>, which can be used to conditionally execute code based on the Spark version.</p></li>
</ol>
</section>
</section>
<section id="shimming-to-support-different-spark-versions">
<h2>Shimming to Support Different Spark Versions<a class="headerlink" href="#shimming-to-support-different-spark-versions" title="Link to this heading">#</a></h2>
<p>If the expression you’re adding has different behavior across different Spark versions, you can use the shim system located in <code class="docutils literal notranslate"><span class="pre">spark/src/main/spark-$SPARK_VERSION/org/apache/comet/shims/CometExprShim.scala</span></code> for each Spark version.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CometExprShim</span></code> trait provides several mechanisms for handling version differences:</p>
<ol class="arabic simple">
<li><p><strong>Version-specific methods</strong> - Override methods in the trait to provide version-specific behavior</p></li>
<li><p><strong>Version-specific expression handling</strong> - Use <code class="docutils literal notranslate"><span class="pre">versionSpecificExprToProtoInternal</span></code> to handle expressions that only exist in certain Spark versions</p></li>
</ol>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">StringDecode</span></code> expression only exists in certain Spark versions. The shim handles this:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">CometExprShim</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">versionSpecificExprToProtoInternal</span><span class="p">(</span>
<span class="w">      </span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Expression</span><span class="p">,</span>
<span class="w">      </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Attribute</span><span class="p">],</span>
<span class="w">      </span><span class="n">binding</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">Expr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">expr</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">StringDecode</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="n">stringDecode</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">charset</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">bin</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">binding</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">None</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">QueryPlanSerde.exprToProtoInternal</span></code> method calls <code class="docutils literal notranslate"><span class="pre">versionSpecificExprToProtoInternal</span></code> first, allowing shims to intercept and handle version-specific expressions before falling back to the standard expression maps.</p>
<p>Your <code class="docutils literal notranslate"><span class="pre">CometExpressionSerde</span></code> implementation can also access shim methods by mixing in the <code class="docutils literal notranslate"><span class="pre">CometExprShim</span></code> trait, though in most cases you can directly access the expression properties if they’re available across all supported Spark versions.</p>
</section>
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/apache/datafusion-comet/pull/297">Variance PR</a></p>
<ul>
<li><p>Aggregation function</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/apache/datafusion-comet/pull/342">Unhex PR</a></p>
<ul>
<li><p>Basic scalar function with shims for different Spark versions</p></li>
</ul>
</li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="adding_a_new_operator.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Adding a New Operator</p>
      </div>
    </a>
    <a class="right-next"
       href="tracing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tracing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p>Apache DataFusion, Apache DataFusion Comet, Apache, the Apache feather logo, and the Apache DataFusion project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>